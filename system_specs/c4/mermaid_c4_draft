C4Component
    title Thermal Grace Dashboard - Component View
    Person(user, "User / Visitor")
    Person(researcher, "Researcher")

    System_Ext(feedback_app, "User Feedback App", "Streamlit survey writer (separate app)")
    System_Ext(mqtt_broker, "MQTT Broker", "sensors/pico/... topics")
    System_Ext(buienradar, "Buienradar API", "Weather data provider")
    System_Ext(github_models, "GitHub Models API", "LLM completion/chat API")
    System_Ext(csv_store, "live_metrics.csv", "Local CSV file")
    System_Ext(feedback_csv, "responses.csv", "Survey responses CSV")
    System_Ext(pico_mmwave, "Pico mmWave+BME680 Node", "Publishes env+radar to MQTT")
    System_Ext(pico_co2, "Pico MTP40F Node", "Publishes CO₂ to MQTT")

    Container_Boundary(app, "Thermal Grace Dashboard (Streamlit)") {
        Component(nav_app, "streamlit_app.py", "Streamlit", "Bootstraps UI, navigation, starts background threads")
        Component(live_metrics, "pages/live_metrics.py", "Streamlit page", "Displays indoor readings, comfort, weather, last payload")
        Component(llm_page, "pages/llm_assistant.py", "Streamlit page", "LLM chat UI using current snapshot/CSV context")
        Component(mqtt_service, "mqtt_service.py", "Background thread", "Subscribes to MQTT, parses payloads, updates state, triggers comfort calc")
        Component(weather_service, "weather_service.py", "Background thread", "Polls Buienradar, updates state")
        Component(state_layer, "state.py", "State/CSV layer", "Thread-safe snapshot store; append/read live_metrics.csv")
        Component(comfort_model, "thermal_comfort_model/comfort_calc.py", "Domain logic", "Computes PMV/PPD/UTCI; derives MET/CLO from survey context")
        Component(llm_utils, "llm_utils.py", "LLM helper", "Builds prompts, calls GitHub Models API")
        Component(feedback_reader, "user_feedback_app/responses.csv reader", "Data source", "Provides latest survey context (read)")
    }

    Rel(user, nav_app, "Uses UI")
    Rel(researcher, nav_app, "Uses UI/analytics")

    Rel(nav_app, live_metrics, "Navigates to")
    Rel(nav_app, llm_page, "Navigates to")
    Rel(nav_app, mqtt_service, "Starts thread")
    Rel(nav_app, weather_service, "Starts thread")

    Rel(mqtt_service, mqtt_broker, "Subscribes / receives", "MQTT")
    Rel(pico_mmwave, mqtt_broker, "Publishes env+radar", "MQTT")
    Rel(pico_co2, mqtt_broker, "Publishes CO₂", "MQTT")

    Rel(mqtt_service, state_layer, "Updates snapshot / appends CSV")
    Rel(weather_service, state_layer, "Updates snapshot")
    Rel(state_layer, csv_store, "Append/Read", "file")

    Rel(mqtt_service, comfort_model, "Calls", "compute_comfort")
    Rel(comfort_model, feedback_reader, "Reads latest survey context", "CSV")
    Rel(feedback_reader, feedback_csv, "Reads", "file")

    Rel(live_metrics, state_layer, "Reads snapshot/CSV")
    Rel(llm_page, llm_utils, "Calls")
    Rel(llm_utils, github_models, "Sends prompts / gets responses", "HTTPS")

    Rel(weather_service, buienradar, "Requests weather", "HTTPS")
    Rel(feedback_app, feedback_csv, "Writes survey responses", "file")